---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import { getLangFromUrl, useTranslations } from '../../../utils/i18n';
import { formatDate, sortByDate, filterByLang } from '../../../utils/helpers';

export async function getStaticPaths() {
  return [
    { params: { lang: 'es' } },
    { params: { lang: 'en' } }
  ];
}

const { lang } = Astro.params;
const t = useTranslations(lang as 'es' | 'en');

// Obtener todos los art√≠culos del archivo
const allArchive = await getCollection('archive');
const archiveArticles = sortByDate(filterByLang(allArchive, lang as string));

// T√≥picos del archivo
const archiveTopics = [
  {
    id: 'web-security',
    title: lang === 'es' ? 'Seguridad Web' : 'Web Security',
    description: lang === 'es' ? 'Tutoriales y gu√≠as sobre seguridad en aplicaciones web' : 'Tutorials and guides on web application security',
    icon: 'üåê',
    color: '#4CAF50'
  },
  {
    id: 'network-security',
    title: lang === 'es' ? 'Seguridad de Redes' : 'Network Security',
    description: lang === 'es' ? 'Conceptos y t√©cnicas de seguridad en redes' : 'Network security concepts and techniques',
    icon: 'üîå',
    color: '#2196F3'
  },
  {
    id: 'binary-exploitation',
    title: lang === 'es' ? 'Explotaci√≥n de Binarios' : 'Binary Exploitation',
    description: lang === 'es' ? 'T√©cnicas de pwn y explotaci√≥n de binarios' : 'Pwn techniques and binary exploitation',
    icon: 'üí£',
    color: '#F44336'
  },
  {
    id: 'cryptography',
    title: lang === 'es' ? 'Criptograf√≠a' : 'Cryptography',
    description: lang === 'es' ? 'Fundamentos y ataques a sistemas criptogr√°ficos' : 'Fundamentals and attacks on cryptographic systems',
    icon: 'üîê',
    color: '#9C27B0'
  },
  {
    id: 'forensics',
    title: lang === 'es' ? 'Forense Digital' : 'Digital Forensics',
    description: lang === 'es' ? 'An√°lisis forense y recuperaci√≥n de evidencias' : 'Forensic analysis and evidence recovery',
    icon: 'üîç',
    color: '#FF9800'
  },
  {
    id: 'reverse-engineering',
    title: lang === 'es' ? 'Ingenier√≠a Inversa' : 'Reverse Engineering',
    description: lang === 'es' ? 'An√°lisis de malware y RE de software' : 'Malware analysis and software RE',
    icon: '‚öôÔ∏è',
    color: '#795548'
  },
  {
    id: 'osint',
    title: 'OSINT',
    description: lang === 'es' ? 'Inteligencia de fuentes abiertas' : 'Open Source Intelligence',
    icon: 'üïµÔ∏è',
    color: '#00BCD4'
  },
  {
    id: 'active-directory',
    title: 'Active Directory',
    description: lang === 'es' ? 'Ataques y defensa en entornos AD' : 'AD attacks and defense',
    icon: 'üè¢',
    color: '#3F51B5'
  },
  {
    id: 'linux',
    title: 'Linux',
    description: lang === 'es' ? 'Seguridad y administraci√≥n en Linux' : 'Linux security and administration',
    icon: 'üêß',
    color: '#607D8B'
  },
  {
    id: 'windows',
    title: 'Windows',
    description: lang === 'es' ? 'Seguridad y explotaci√≥n en Windows' : 'Windows security and exploitation',
    icon: 'ü™ü',
    color: '#0078D4'
  },
  {
    id: 'tools',
    title: lang === 'es' ? 'Herramientas' : 'Tools',
    description: lang === 'es' ? 'Gu√≠as de herramientas de pentesting' : 'Pentesting tools guides',
    icon: 'üõ†Ô∏è',
    color: '#FF5722'
  },
  {
    id: 'methodology',
    title: lang === 'es' ? 'Metodolog√≠a' : 'Methodology',
    description: lang === 'es' ? 'Metodolog√≠as y frameworks de pentesting' : 'Pentesting methodologies and frameworks',
    icon: 'üìã',
    color: '#009688'
  },
  {
    id: 'privilege-escalation',
    title: lang === 'es' ? 'Escalada de Privilegios' : 'Privilege Escalation',
    description: lang === 'es' ? 'T√©cnicas de escalada en Linux y Windows' : 'Privilege escalation techniques on Linux and Windows',
    icon: '‚¨ÜÔ∏è',
    color: '#E91E63'
  },
  {
    id: 'other',
    title: lang === 'es' ? 'Otros' : 'Other',
    description: lang === 'es' ? 'Recursos y tutoriales diversos' : 'Miscellaneous resources and tutorials',
    icon: 'üìö',
    color: '#9E9E9E'
  }
];

// Categor√≠as de contenido
const contentCategories = [
  { id: 'tutorial', label: lang === 'es' ? 'Tutoriales' : 'Tutorials', icon: 'üìñ' },
  { id: 'cheatsheet', label: lang === 'es' ? 'Cheatsheets' : 'Cheatsheets', icon: 'üìù' },
  { id: 'guide', label: lang === 'es' ? 'Gu√≠as' : 'Guides', icon: 'üó∫Ô∏è' },
  { id: 'tool', label: lang === 'es' ? 'Herramientas' : 'Tools', icon: '‚öíÔ∏è' },
  { id: 'resource', label: lang === 'es' ? 'Recursos' : 'Resources', icon: 'üíé' },
  { id: 'note', label: lang === 'es' ? 'Notas' : 'Notes', icon: 'üìå' },
  { id: 'research', label: lang === 'es' ? 'Investigaci√≥n' : 'Research', icon: 'üî¨' }
];

// Contar art√≠culos por t√≥pico
const topicCounts = archiveTopics.map(topic => ({
  ...topic,
  count: archiveArticles.filter(a => a.data.topic === topic.id).length
}));

// Contar art√≠culos por categor√≠a
const categoryCounts = contentCategories.map(cat => ({
  ...cat,
  count: archiveArticles.filter(a => a.data.category === cat.id).length
}));

const recentArticles = archiveArticles.slice(0, 6);
---

<Layout
  title={lang === 'es' ? 'Archivo de Conocimiento' : 'Knowledge Archive'}
  description={lang === 'es' ? 'Recursos, tutoriales y gu√≠as sobre seguridad inform√°tica' : 'Resources, tutorials and guides on cybersecurity'}
  lang={lang}
>
  <main class="archive-index">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">
          {lang === 'es' ? 'üìö Archivo de Conocimiento' : 'üìö Knowledge Archive'}
        </h1>
        <p class="page-description">
          {lang === 'es' 
            ? 'Colecci√≥n de tutoriales, cheatsheets, gu√≠as y recursos sobre seguridad inform√°tica y hacking √©tico' 
            : 'Collection of tutorials, cheatsheets, guides and resources on cybersecurity and ethical hacking'}
        </p>
        <div class="stats-bar">
          <div class="stat">
            <span class="stat-value">{archiveArticles.length}</span>
            <span class="stat-label">{lang === 'es' ? 'Art√≠culos' : 'Articles'}</span>
          </div>
          <div class="stat">
            <span class="stat-value">{topicCounts.filter(t => t.count > 0).length}</span>
            <span class="stat-label">{lang === 'es' ? 'T√≥picos' : 'Topics'}</span>
          </div>
          <div class="stat">
            <span class="stat-value">{categoryCounts.filter(c => c.count > 0).length}</span>
            <span class="stat-label">{lang === 'es' ? 'Tipos' : 'Types'}</span>
          </div>
        </div>
      </header>

      <section class="categories-section">
        <h2 class="section-title">
          {lang === 'es' ? 'üìÇ Tipos de Contenido' : 'üìÇ Content Types'}
        </h2>
        <div class="content-types">
          {categoryCounts.map((category) => (
            <a 
              href={`/${lang}/archive/category/${category.id}`} 
              class="content-type-card"
            >
              <span class="type-icon">{category.icon}</span>
              <div class="type-info">
                <span class="type-label">{category.label}</span>
                <span class="type-count">{category.count}</span>
              </div>
            </a>
          ))}
        </div>
      </section>

      <section class="topics-section">
        <h2 class="section-title">
          {lang === 'es' ? 'üéØ T√≥picos' : 'üéØ Topics'}
        </h2>
        <div class="topics-grid">
          {topicCounts.map((topic) => (
            <a 
              href={`/${lang}/archive/topic/${topic.id}`} 
              class="topic-card"
              style={`--topic-color: ${topic.color}`}
            >
              <div class="topic-header">
                <span class="topic-icon">{topic.icon}</span>
                <h3 class="topic-title">{topic.title}</h3>
              </div>
              <p class="topic-description">{topic.description}</p>
              <div class="topic-footer">
                <span class="article-count">
                  {topic.count} {lang === 'es' ? 'art√≠culos' : 'articles'}
                </span>
              </div>
            </a>
          ))}
        </div>
      </section>

      {recentArticles.length > 0 && (
        <section class="recent-section">
          <h2 class="section-title">
            {lang === 'es' ? 'üÜï A√±adido Recientemente' : 'üÜï Recently Added'}
          </h2>
          <div class="articles-grid">
            {recentArticles.map((article) => (
              <a href={`/${lang}/archive/${article.slug}`} class="article-card">
                {article.data.heroImage && (
                  <div class="article-image">
                    <img src={article.data.heroImage} alt={article.data.title} />
                  </div>
                )}
                <div class="article-content">
                  <div class="article-meta">
                    <span class="category-badge">
                      {contentCategories.find(c => c.id === article.data.category)?.icon}
                      {contentCategories.find(c => c.id === article.data.category)?.label}
                    </span>
                  </div>
                  <h3 class="article-title">{article.data.title}</h3>
                  <p class="article-description">{article.data.description}</p>
                  <div class="article-footer">
                    <span class="topic-tag">
                      {archiveTopics.find(t => t.id === article.data.topic)?.icon}
                      {archiveTopics.find(t => t.id === article.data.topic)?.title}
                    </span>
                    <time datetime={article.data.pubDate.toISOString()}>
                      {formatDate(article.data.pubDate, lang as 'es' | 'en')}
                    </time>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </section>
      )}

      {archiveArticles.length === 0 && (
        <div class="empty-state">
          <span class="empty-icon">üìù</span>
          <h3>{lang === 'es' ? 'Pr√≥ximamente' : 'Coming Soon'}</h3>
          <p>
            {lang === 'es' 
              ? 'Estamos preparando contenido para el archivo. ¬°Vuelve pronto!' 
              : 'We are preparing content for the archive. Come back soon!'}
          </p>
        </div>
      )}
    </div>
  </main>
</Layout>

<style>
  .archive-index {
    padding: 2rem 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .page-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .page-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .page-description {
    font-size: 1.2rem;
    color: var(--text-muted);
    max-width: 800px;
    margin: 0 auto 2rem;
  }

  .stats-bar {
    display: flex;
    justify-content: center;
    gap: 3rem;
    margin-top: 2rem;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--accent);
  }

  .stat-label {
    font-size: 0.9rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .section-title {
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: 2rem;
  }

  .categories-section {
    margin-bottom: 4rem;
  }

  .content-types {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
  }

  .content-type-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    text-decoration: none;
    color: var(--text);
    transition: all 0.3s ease;
  }

  .content-type-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: var(--accent);
  }

  .type-icon {
    font-size: 2rem;
  }

  .type-info {
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .type-label {
    font-weight: 600;
    font-size: 1rem;
  }

  .type-count {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .topics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 4rem;
  }

  .topic-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    color: var(--text);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .topic-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--topic-color);
    transition: width 0.3s ease;
  }

  .topic-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border-color: var(--topic-color);
  }

  .topic-card:hover::before {
    width: 8px;
  }

  .topic-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .topic-icon {
    font-size: 2rem;
  }

  .topic-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
  }

  .topic-description {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }

  .topic-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .article-count {
    font-size: 0.9rem;
    color: var(--topic-color);
    font-weight: 600;
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 2rem;
  }

  .article-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    text-decoration: none;
    color: var(--text);
    transition: all 0.3s ease;
  }

  .article-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .article-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
  }

  .article-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-content {
    padding: 1.5rem;
  }

  .article-meta {
    margin-bottom: 0.75rem;
  }

  .category-badge {
    padding: 0.25rem 0.75rem;
    background: var(--accent-bg);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .article-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .article-description {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .article-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .topic-tag {
    padding: 0.25rem 0.75rem;
    background: var(--accent-bg);
    border-radius: 12px;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-icon {
    font-size: 4rem;
    display: block;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 2rem;
    }

    .stats-bar {
      gap: 1.5rem;
    }

    .content-types,
    .topics-grid,
    .articles-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
